/*
================================================================================
  MODERN & DYNAMIC MESSAGE LAYOUT v27 by AI Archaea & Gemini Pro
================================================================================
  AUTHORS: AI Archaea & AI Assistant (Gemini Pro)
  LAST UPDATED: July 1, 2024

  FEATURES & REFACTORING IMPROVEMENTS (v27):
  - GHOST ICON & TIMESTAMP FIX (FINAL): Solved the shifting issue by completely
    isolating the character name from the timestamp using absolute positioning.
    The timestamp and its icon now remain stable in the layout flow.
  - ROBUST LAYOUT: The character name is now an 'overlay' on top of the
    timestamp, preventing any layout shifts.
  - IMPROVED VARIABLES: Added new, clearer variables for positioning the name
    and timestamp groups independently for easier customization.
  - MAINTAINABILITY: The new logic is more intuitive. The timestamp sits at a
    base position, and the name is placed relative to it.
================================================================================
*/


/* --- Step 1: GLOBAL CUSTOMIZATION VARIABLES --- */
:root {
    /* -- Layout & Sizing -- */
    --avatar-left-margin: 0px;
    --avatar-right-margin: 2px;
    --avatar-border: none;
    --header-height: 100px;
    --info-block-left-padding: 1px;

    /* -- Base calculation for the left position of all info blocks -- */
    --info-block-base-left: calc(var(--avatar-width) + var(--avatar-right-margin) + var(--avatar-left-margin) + var(--info-block-left-padding));

    /* --- REFACTORED: Name & Timestamp Block Styling --- */
    --header-name-font: "Brillant", serif;
    --header-name-size: 24px;
    --header-name-color: var(--SmartThemeBodyColor);
    --header-name-glow: 0 0 7px #FFFFE0;

    /* Top position for the ENTIRE info block container */
    --info-block-top-offset: 45px;

    /* ++ NEW: Controls for the NAME position ++ */
    /* Position of the name, relative to the top-left of the info block. */
    --name-vertical-offset: -20px; /* Negative values move it up */
    --name-horizontal-offset: 0px;

    /* ++ NEW: Controls for the TIMESTAMP position ++ */
    /* This positions the entire timestamp/icon group. */
    --timestamp-group-vertical-offset: -20px;
    --timestamp-group-horizontal-offset: 0px;
    --timestamp-icon-gap: 5px;

    /* -- Metadata Block Styling -- */
    --metadata-font-size: calc(var(--mainFontSize) * 0.75);
    --metadata-font-weight: 400;
    --metadata-vertical-offset: 50px; /* Distance below the timestamp */
    --metadata-horizontal-offset: 80px;
    --metadata-gap: 2px;
    --metadata-stack-transform: translate(5px, 55px);

    /* -- Button Positioning -- */
    --buttons-top-offset: 70px;
    --buttons-right-offset: 5px;
    --edit-buttons-top-offset: 90px;
    --edit-buttons-right-offset: 25px;
    --reasoning-edit-top-compensation: -100px;
    --reasoning-edit-right-compensation: -40px;
    --reasoning-actions-offset: 15px;
    --reasoning-actions-right-offset: -2px;
    --reasoning-header-width: 280px;
    --reasoning-textarea-right-margin: 10px;
}

/* --- Step 2: CORE MESSAGE STRUCTURE --- */
body.voiddrift-theme #chat .mes {
    display: block;
    position: relative;
    padding-top: var(--header-height) !important;
    margin-top: 5px;
    overflow: visible;
}

body.voiddrift-theme #chat .last_mes .mesAvatarWrapper {
    padding-bottom: 0px;
}

body.voiddrift-theme #chat .mes .mes_block {
    display: block;
    overflow-x: visible;
    transform: none !important;
}

body.voiddrift-theme #chat .mes .mesAvatarWrapper {
    display: flex;
    flex-direction: row;
    align-items: flex-start; /* Align top of avatar with top of metadata stack */
    gap: var(--avatar-right-margin); /* The space between avatar and metadata */
    float: left;
    width: var(--avatar-width);
    margin-left: var(--avatar-left-margin);
    margin-right: var(--avatar-right-margin);
    margin-top: calc(-1 * var(--header-height) + 10px);
    position: relative;
    z-index: 10;
}


body.voiddrift-theme #chat .mes .mes_block {
    display: block;
    overflow-x: visible;
    transform: none !important;
}

/* --- Step 3: AVATAR & HEADER BANNER STYLING --- */
body.voiddrift-theme #chat .mes .avatar,
body.voiddrift-theme #chat .mes .avatar img {
    width: var(--avatar-width);
    height: auto;
    object-fit: cover;
    margin-top: -5px;
    margin-left: -7px;
}

body.voiddrift-theme #chat .mes .avatar img {
    border: var(--avatar-border);
    -webkit-mask-image:
        radial-gradient(ellipse at center, black 60%, transparent 100%),
        linear-gradient(to bottom, black 80%, transparent 100%),
        linear-gradient(to right,  black 85%, transparent 100%);
    -webkit-mask-composite: source-in;
    mask-image:
        radial-gradient(ellipse at center, black 60%, transparent 100%),
        linear-gradient(to bottom, black 80%, transparent 100%),
        linear-gradient(to right,  black 85%, transparent 100%);
    mask-composite: intersect;
    mask-repeat: no-repeat;
}

body.voiddrift-theme #chat .mes[is_user="false"]::before,
body.voiddrift-theme #chat .mes[is_user="true"]::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 60%;
    height: calc(var(--header-height) + 10px);
    background-image: var(--mes-avatar-url);
    background-size: cover;
    -webkit-mask-image: linear-gradient(to left, black 60%, transparent 100%), linear-gradient(to bottom, black 85%, transparent 100%) !important;
    -webkit-mask-composite: intersect !important;
    mask-image: linear-gradient(to left, black 80%, transparent 100%), linear-gradient(to bottom, black 85%, transparent 100%) !important;
    mask-composite: intersect !important;
    mask-repeat: no-repeat;
    opacity: 0.8;
    z-index: 0;
}
body.voiddrift-theme #chat .mes[is_user="false"]::before { background-position: center var(--character-banner-pos, 27%); }
body.voiddrift-theme #chat .mes[is_user="true"]::before { background-position: center var(--persona-banner-pos, 15%); }


/* --- Step 4: REPOSITIONED INFO BLOCK (The Stable Solution) --- */
/* This is the main container that holds the name/timestamp/metadata. */
body.voiddrift-theme #chat .mes .mes_block .ch_name {
    position: absolute;
    left: var(--info-block-base-left);
    top: var(--info-block-top-offset);
    z-index: 5;
    height: auto;
    margin: 0;
    width: calc(100% - var(--info-block-base-left));
}

/* This is the "stage" for our info elements. We make it a positioning
   context so we can absolutely position children inside it. */
body.voiddrift-theme #chat .mes .mes_block .ch_name .flex-container.alignItemsBaseline {
    position: relative; /* CRITICAL: This is the new anchor. */
    display: flex; /* This will now only apply to timestamp & its icon. */
    align-items: center; /* Vertically align timestamp text and icon. */
    gap: var(--timestamp-icon-gap);
    /* Use transform to move the whole timestamp/icon group into place. */
    transform: translate(var(--timestamp-group-horizontal-offset), var(--timestamp-group-vertical-offset));
}

/* ISOLATED Character Name: Pulled out of the layout flow completely. */
body.voiddrift-theme #chat .mes .mes_block .ch_name .name_text {
    position: absolute; /* Pull it out of the flexbox flow. */
    top: 0;
    left: 0;
    z-index: 7; /* Ensure it's on top. */
    margin: 0;
    font-family: var(--header-name-font);
    font-size: var(--header-name-size);
    color: var(--header-name-color);
    text-shadow: var(--header-name-glow);
    /* Nudge it into its final position. */
    transform: translate(var(--name-horizontal-offset), var(--name-vertical-offset));
    white-space: nowrap;
}



/* The Timestamp & Icon are now the ONLY items in the flex layout,
   so they will sit together correctly and will not be shifted. */
body.voiddrift-theme #chat .mes .mes_block .ch_name .timestamp,
body.voiddrift-theme #chat .mes .mes_block .ch_name .timestamp-icon {
    white-space: nowrap;
    margin-top: 15px;
}

/* Metadata items are positioned relative to the main .ch_name container. */
body.voiddrift-theme #chat .mes .mesIDDisplay,
body.voiddrift-theme #chat .mes .tokenCounterDisplay,
body.voiddrift-theme #chat .mes .mes_timer {
    font-size: var(--metadata-font-size);
    font-weight: var(--metadata-font-weight);
    color: var(--SmartThemeBodyColor);
    text-shadow: 0px 0px calc(var(--shadowWidth) * 1px) var(--SmartThemeShadowColor);
    
    /*! position: absolute; */
    margin: 0;
    z-index: 5;
    /* Position them relative to the main .ch_name anchor. */
    display: flex;
    flex-direction: column; 
    justify-content: left;
    /*! transform: translate(310px,-400px); */   
    
    left: var(--metadata-horizontal-offset); 
    top: var(--metadata-vertical-offset);
     
    white-space: nowrap;
    transform: var(--metadata-stack-transform);
}
/* We must group them together since they are separate elements in the HTML */
body.voiddrift-theme #chat .mes .mesIDDisplay { order: 1; }
body.voiddrift-theme #chat .mes .tokenCounterDisplay { order: 2; }
body.voiddrift-theme #chat .mes .mes_timer { order: 3; }



/* --- Step 5: MESSAGE CONTENT & BUTTONS --- */
body.voiddrift-theme #chat .mes .mes_block .mes_text {
    padding-top: 55px;
    padding-right: 15px !important;
    padding-bottom: 10px;
    margin-left: 1px !important;
    font-size: 16px;
    position: relative;
}

/* Reasoning block styling */
body.voiddrift-theme #chat .mes .mes_reasoning_details {
    margin-top: 35px;
    position: relative;
    margin-bottom: -30px;
    z-index: 4;
}

body.voiddrift-theme #chat .mes .mes_reasoning_header_block {
    width: var(--reasoning-header-width);
    max-width: var(--reasoning-header-width);
    position: relative;
    min-height: 28px;
    padding: 0;
}

body.voiddrift-theme #chat .mes .mes_reasoning_header {
    background-color: var(--SmartThemeEmColor);
    min-height: 22px;
    line-height: 1;
    font-size: 14px;
}

body.voiddrift-theme #chat .mes .mes_reasoning_actions {
    position: absolute;
    top: var(--reasoning-actions-offset);
    right: var(--reasoning-actions-right-offset);
    z-index: 4;
    width: auto;
    margin: 0;
}

body.voiddrift-theme #chat .mes .reasoning_edit_textarea {
    margin-right: var(--reasoning-textarea-right-margin);
    padding-right: 10px;
    margin-bottom: -25px;
    margin-top: 55px;
    width: calc(100% - var(--reasoning-textarea-right-margin) + 25px);
    resize: vertical;
    min-height: 60px;
    max-width: none;
}

body.voiddrift-theme #chat .mes .mes_reasoning {
    padding-right: var(--reasoning-textarea-right-margin);
    margin-right: 0px;
    margin-bottom: -30px;
}

/* State-aware styling for reasoning edit buttons */
body.voiddrift-theme #chat .mes_reasoning_details:has(.reasoning_edit_textarea) .mes_reasoning_actions {
    top: calc(var(--edit-buttons-top-offset) + var(--reasoning-edit-top-compensation));
    right: calc(var(--edit-buttons-right-offset) + var(--reasoning-edit-right-compensation));
}

/* ENHANCED BUTTONS: Positioned with transform for stability */
body.voiddrift-theme #chat .mes .mes_buttons {
    position: absolute;
    z-index: 5;
    top: var(--buttons-top-offset) !important;
    right: var(--buttons-right-offset) !important;
    left: unset !important;
    margin: 0 !important;
    transform: translate(var(--buttons-horizontal-nudge), var(--buttons-vertical-nudge));
}

body.voiddrift-theme #chat .mes .mes_edit_buttons {
    position: absolute !important;
    z-index: 5;
    top: var(--edit-buttons-top-offset) !important;
    right: var(--edit-buttons-right-offset) !important;
    transform: translate(var(--edit-buttons-horizontal-nudge), var(--edit-buttons-vertical-nudge));
}

/* More specific rule to override documentstyle defaults */
body.voiddrift-theme.documentstyle #chat .mes .mes_edit_buttons {
    right: var(--edit-buttons-right-offset) !important;
    transform: translate(var(--edit-buttons-horizontal-nudge), var(--edit-buttons-vertical-nudge));
}


/* --- Step 6: ADAPTIVE & THEME-SPECIFIC STYLING --- */
/* Dynamic border-radius rules for different ST themes */
body.voiddrift-theme #chat .mes .avatar img { border-radius: 10px; }
body.voiddrift-theme:not(.bubblechat) #chat .mes .avatar img,
body.voiddrift-theme.documentstyle #chat .mes .avatar img { border-radius: 0; }

body.voiddrift-theme #chat .mes::before { border-radius: 0 5px 0 0; }
body.voiddrift-theme:not(.bubblechat) #chat .mes::before,
body.voiddrift-theme.documentstyle #chat .mes::before { border-radius: 0; }

/* Spacing for swipe actions etc. */
body.voiddrift-theme #chat .swipe_right,
body.voiddrift-theme #chat .swipe_left { bottom: 19px !important; }
body.voiddrift-theme #chat .swipe_left { left: 5px !important; }
body.voiddrift-theme #chat .last_mes .mes_block { padding-bottom: 28px !important; }