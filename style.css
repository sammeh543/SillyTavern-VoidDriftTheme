/*
================================================================================
  MODERN & DYNAMIC MESSAGE LAYOUT v26 by AI Archaea & Gemini Pro
================================================================================
  AUTHORS: AI Archaea & AI Assistant (Gemini Pro)
  LAST UPDATED: July 1, 2024

  FEATURES & REFACTORING IMPROVEMENTS (v26):
  - GHOST ICON FIX: Timestamp and metadata are now positioned independently and will
    NOT shift when the ghost icon appears.
  - ROBUST LAYOUT: Replaced fragile flexbox positioning for the timestamp with a
    stable absolute position + transform combo.
  - SIMPLIFIED LOGIC: Name/Ghost and Timestamp now have their own containers,
    making their positioning logic much cleaner and more predictable.
  - BROWSER CONSISTENCY: Updated variables and added fallbacks for better
    cross-browser support (Chrome, Edge, Firefox).
  - MAINTAINABILITY: Added extensive comments explaining the new, more robust
    layout strategy.
================================================================================
*/


/* --- Step 1: GLOBAL CUSTOMIZATION VARIABLES --- */
/* Tweak these values to change the entire layout! */
/* ----------------------------------------------- */
:root {
    /* -- Layout & Sizing -- */
    --avatar-left-margin: 0px;              /* Space on the far left of the avatar. */
    --avatar-right-margin: 20px;            /* Space between avatar and text. */
    --avatar-border: none;                  /* e.g., '2px solid #555' or 'none'. */
    --header-height: 100px;                 /* Reserved space at the top for the header. */
    --info-block-left-padding: 1px;         /* Nudges the entire info area (name, timestamp, etc). */

    /* -- This is the BASE calculation for the left position of all info blocks -- */
    --info-block-base-left: calc(var(--avatar-width) + var(--avatar-right-margin) + var(--avatar-left-margin) + var(--info-block-left-padding));

    /* --- REFACTORED: Name & Timestamp Block Styling --- */
    --header-name-font: "Brillant", serif;
    --header-name-size: 24px;
    --header-name-color: var(--SmartThemeBodyColor);
    --header-name-glow: 0 0 7px #FFFFE0; /* Kept for reference, but may not be needed */

    /* Top position for the ENTIRE info block container */
    --info-block-top-offset: 25px;

    /* Nudges the name/ghost container up/down. Negative values go up. */
    --name-vertical-nudge: -19px;

    /* Nudges the timestamp & icon left/right. Negative values go left. */
    /* -75px is the new standard for better Chrome/Edge compatibility. */
    --timestamp-horizontal-nudge: 0px;
    --timestamp-icon-gap: 5px;              /* Space between timestamp text and its icon. */

    /* -- Metadata Block Styling (REFACTORED with flexbox and transforms) -- */
    --metadata-font-size: calc(var(--mainFontSize) * 0.75);
    --metadata-font-weight: 400;
    --metadata-vertical-offset: 45px;       /* How far down from the info block to start metadata stack */
    --metadata-horizontal-offset: -10px;    /* Horizontal nudge for the entire metadata stack */
    --metadata-gap: 2px;                    /* Vertical gap between metadata items */

    /* -- Independent Button Positioning (ENHANCED with transforms) -- */
    --buttons-top-offset: 90px;
    --buttons-right-offset: 5px;
    --buttons-horizontal-nudge: 0px;
    --buttons-vertical-nudge: 0px;

    --edit-buttons-top-offset: 90px;
    --edit-buttons-right-offset: 25px;
    --edit-buttons-horizontal-nudge: 0px;
    --edit-buttons-vertical-nudge: 0px;

    --reasoning-edit-top-compensation: -100px;
    --reasoning-edit-right-compensation: -40px;

    /* -- Reasoning Block Controls -- */
    --reasoning-actions-offset: 15px;
    --reasoning-actions-right-offset: -2px;
    --reasoning-header-width: 280px;
    --reasoning-textarea-right-margin: 10px;
}

/* --- Step 2: CORE MESSAGE STRUCTURE --- */
body.voiddrift-theme #chat .mes {
    display: block;
    position: relative;
    padding-top: var(--header-height) !important;
    margin-top: 5px;
    overflow: visible;
}

body.voiddrift-theme #chat .mes .mesAvatarWrapper {
    display: inline;
    float: left;
    width: var(--avatar-width);
    margin-left: var(--avatar-left-margin);
    margin-right: var(--avatar-right-margin);
    margin-top: calc(-1 * var(--header-height) + 10px);
    position: relative;
    z-index: 10;
}

body.voiddrift-theme #chat .last_mes .mesAvatarWrapper {
    padding-bottom: 0px;
}

body.voiddrift-theme #chat .mes .mes_block {
    display: block;
    overflow-x: visible;
    /* FIX: Added !important to win against inline styles from swipe JS */
    transform: none !important;
}

/* --- Step 3: AVATAR & HEADER BANNER STYLING --- */
body.voiddrift-theme #chat .mes .avatar,
body.voiddrift-theme #chat .mes .avatar img {
    width: 100%;
    height: auto;
    object-fit: cover;
    margin-top: -5px;
    margin-left: -7px;
}

body.voiddrift-theme #chat .mes .avatar img {
    border: var(--avatar-border);
    -webkit-mask-image:
        radial-gradient(ellipse at center, black 60%, transparent 100%),
        linear-gradient(to bottom, black 80%, transparent 100%),
        linear-gradient(to right,  black 85%, transparent 100%);
    -webkit-mask-composite: source-in;
    mask-image:
        radial-gradient(ellipse at center, black 60%, transparent 100%),
        linear-gradient(to bottom, black 80%, transparent 100%),
        linear-gradient(to right,  black 85%, transparent 100%);
    mask-composite: intersect;
    mask-repeat: no-repeat;
}

body.voiddrift-theme #chat .mes[is_user="false"]::before,
body.voiddrift-theme #chat .mes[is_user="true"]::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 60%;
    height: calc(var(--header-height) + 10px);
    background-image: var(--mes-avatar-url);
    background-size: cover;
    -webkit-mask-image:
        linear-gradient(to left, black 60%, transparent 100%),
        linear-gradient(to bottom, black 85%, transparent 100%) !important;
    -webkit-mask-composite: intersect !important;
    mask-image:
        linear-gradient(to left, black 80%, transparent 100%),
        linear-gradient(to bottom, black 85%, transparent 100%) !important;
    mask-composite: intersect !important;
    mask-repeat: no-repeat;
    opacity: 0.8;
    z-index: 0;
}
body.voiddrift-theme #chat .mes[is_user="false"]::before { background-position: center var(--character-banner-pos, 27%); }
body.voiddrift-theme #chat .mes[is_user="true"]::before { background-position: center var(--persona-banner-pos, 15%); }


/* --- Step 4: REPOSITIONED INFO BLOCK (REFACTORED for stability) --- */
/* The main container for name, timestamp, and metadata. It's positioned
   absolutely, and all its children will be positioned relative to it. */
/* --------------------------------------------------------------------- */
body.voiddrift-theme #chat .mes .mes_block .ch_name {
    position: absolute;
    left: var(--info-block-base-left);
    top: var(--info-block-top-offset);
    z-index: 5;
    height: auto;
    margin: 0;
    width: calc(100% - var(--info-block-base-left)); /* Take up remaining space */
}

/* This is the container for the NAME and GHOST ICON only.
   We nudge this container vertically. */
body.voiddrift-theme #chat .mes .mes_block .ch_name .flex-container.alignItemsBaseline {
    display: flex; /* Kept as flex to align name and ghost icon */
    flex-direction: row;
    align-items: baseline;
    gap: 7px; /* Space between name and ghost icon */
    position: relative; /* Make it a positioning context for children if needed */
    width: auto; /* Don't let it take full width, just wrap its content */
    /* Apply the vertical nudge to the entire name/ghost block */
    transform: translateY(var(--name-vertical-nudge));
}

/* Character Name Styling */
body.voiddrift-theme #chat .mes .mes_block .ch_name .name_text {
    z-index: 6;
    margin: 0;
    font-family: var(--header-name-font);
    font-size: var(--header-name-size);
    color: var(--header-name-color);
    text-shadow: var(--header-name-glow);
}

/* Ghost Icon Styling */
body.voiddrift-theme #chat .mes .mes_block .ch_name .mes_ghost {
    align-items: center;
    z-index: 7;
    flex-shrink: 0; /* Prevent it from shrinking */
}

/* The Timestamp & Icon (ISOLATED AND STABLE)
   This is now positioned absolutely relative to .ch_name, so the ghost
   icon's presence cannot affect it. We use transforms for precise placement. */
body.voiddrift-theme #chat .mes .mes_block .ch_name .timestamp {
    position: absolute;
    left: 0;
    top: 0;
    z-index: 6;

    /* Use transform to nudge it into place without affecting other elements */
    transform: translate(var(--timestamp-horizontal-nudge), calc(var(--name-vertical-nudge) + 50px));

    /* Use flex to keep its own text and icon together */
    display: flex;
    align-items: center;
    gap: var(--timestamp-icon-gap);
    white-space: nowrap; /* Prevent wrapping on different screen sizes */
}

/* All metadata items (ID, Tokens, Timer) */
body.voiddrift-theme #chat .mes .mesIDDisplay,
body.voiddrift-theme #chat .mes .tokenCounterDisplay,
body.voiddrift-theme #chat .mes .mes_timer {
    font-size: var(--metadata-font-size);
    font-weight: var(--metadata-font-weight);
    color: var(--SmartThemeBodyColor);
    text-shadow: 0px 0px calc(var(--shadowWidth) * 1px) var(--SmartThemeShadowColor);
    position: absolute;
    margin: 0;
    z-index: 5;
    /* Start all metadata items from the same point */
    left: calc(var(--info-block-base-left) + var(--metadata-horizontal-offset));
    top: var(--metadata-vertical-offset);
}

/* Use transforms to create a stable vertical stack for metadata */
body.voiddrift-theme #chat .mes .mesIDDisplay {
    transform: translateY(calc(0 * (1em + var(--metadata-gap))));
}
body.voiddrift-theme #chat .mes .tokenCounterDisplay {
    transform: translateY(calc(1 * (1em + var(--metadata-gap))));
}
body.voiddrift-theme #chat .mes .mes_timer {
    transform: translateY(calc(2 * (1em + var(--metadata-gap))));
}

/* --- Step 5: MESSAGE CONTENT & BUTTONS --- */
body.voiddrift-theme #chat .mes .mes_block .mes_text {
    padding-top: 55px;
    padding-right: 15px !important;
    padding-bottom: 10px;
    margin-left: 1px !important;
    font-size: 16px;
    position: relative;
}

/* Reasoning block styling */
body.voiddrift-theme #chat .mes .mes_reasoning_details {
    margin-top: 35px;
    position: relative;
    margin-bottom: -30px;
    z-index: 4;
}

body.voiddrift-theme #chat .mes .mes_reasoning_header_block {
    width: var(--reasoning-header-width);
    max-width: var(--reasoning-header-width);
    position: relative;
    min-height: 28px;
    padding: 0;
}

body.voiddrift-theme #chat .mes .mes_reasoning_header {
    background-color: var(--SmartThemeEmColor);
    min-height: 22px;
    line-height: 1;
    font-size: 14px;
}

body.voiddrift-theme #chat .mes .mes_reasoning_actions {
    position: absolute;
    top: var(--reasoning-actions-offset);
    right: var(--reasoning-actions-right-offset);
    z-index: 4;
    width: auto;
    margin: 0;
}

body.voiddrift-theme #chat .mes .reasoning_edit_textarea {
    margin-right: var(--reasoning-textarea-right-margin);
    padding-right: 10px;
    margin-bottom: -25px;
    margin-top: 55px;
    width: calc(100% - var(--reasoning-textarea-right-margin) + 25px);
    resize: vertical;
    min-height: 60px;
    max-width: none;
}

body.voiddrift-theme #chat .mes .mes_reasoning {
    padding-right: var(--reasoning-textarea-right-margin);
    margin-right: 0px;
    margin-bottom: -30px;
}

/* State-aware styling for reasoning edit buttons */
body.voiddrift-theme #chat .mes_reasoning_details:has(.reasoning_edit_textarea) .mes_reasoning_actions {
    top: calc(var(--edit-buttons-top-offset) + var(--reasoning-edit-top-compensation));
    right: calc(var(--edit-buttons-right-offset) + var(--reasoning-edit-right-compensation));
}

/* ENHANCED BUTTONS: Positioned with transform for stability */
body.voiddrift-theme #chat .mes .mes_buttons {
    position: absolute;
    z-index: 5;
    top: var(--buttons-top-offset) !important;
    right: var(--buttons-right-offset) !important;
    left: unset !important;
    margin: 0 !important;
    transform: translate(var(--buttons-horizontal-nudge), var(--buttons-vertical-nudge));
}

body.voiddrift-theme #chat .mes .mes_edit_buttons {
    position: absolute !important;
    z-index: 5;
    top: var(--edit-buttons-top-offset) !important;
    right: var(--edit-buttons-right-offset) !important;
    transform: translate(var(--edit-buttons-horizontal-nudge), var(--edit-buttons-vertical-nudge));
}

/* More specific rule to override documentstyle defaults */
body.voiddrift-theme.documentstyle #chat .mes .mes_edit_buttons {
    right: var(--edit-buttons-right-offset) !important;
    transform: translate(var(--edit-buttons-horizontal-nudge), var(--edit-buttons-vertical-nudge));
}


/* --- Step 6: ADAPTIVE & THEME-SPECIFIC STYLING --- */
/* Dynamic border-radius rules for different ST themes */
body.voiddrift-theme #chat .mes .avatar img { border-radius: 10px; }
body.voiddrift-theme:not(.bubblechat) #chat .mes .avatar img,
body.voiddrift-theme.documentstyle #chat .mes .avatar img { border-radius: 0; }

body.voiddrift-theme #chat .mes::before { border-radius: 0 5px 0 0; }
body.voiddrift-theme:not(.bubblechat) #chat .mes::before,
body.voiddrift-theme.documentstyle #chat .mes::before { border-radius: 0; }

/* Spacing for swipe actions etc. */
body.voiddrift-theme #chat .swipe_right,
body.voiddrift-theme #chat .swipe_left { bottom: 19px !important; }
body.voiddrift-theme #chat .swipe_left { left: 5px !important; }
body.voiddrift-theme #chat .last_mes .mes_block { padding-bottom: 28px !important; }